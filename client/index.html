<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”å­æ£‹ - åœ¨çº¿å¯¹æˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5A2B',
                        secondary: '#D2B48C',
                        board: '#DEB887',
                        black: '#000000',
                        white: '#FFFFFF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .board-grid {
                background-size: 100% 100%;
                background-image: linear-gradient(to right, rgba(0,0,0,0.6) 1px, transparent 1px),
                                  linear-gradient(to bottom, rgba(0,0,0,0.6) 1px, transparent 1px);
            }
            .piece-shadow {
                filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));
            }
            .piece-transition {
                transition: all 0.2s ease-out;
            }
            .btn-hover {
                transition: all 0.2s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.05);
                    opacity: 0.8;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .slide-in {
                animation: slideIn 0.3s ease-in-out;
            }
            @keyframes slideIn {
                from {
                    transform: translateX(-20px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 font-sans">
    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-4xl w-full bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="bg-primary text-white p-6 text-center">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold">äº”å­æ£‹</h1>
            <p class="text-secondary mt-2">åœ¨çº¿å¯¹æˆ˜æ¸¸æˆ</p>
        </div>
        
        <!-- æ¸¸æˆæ¨¡å¼é€‰æ‹©ç•Œé¢ -->
        <div id="modeSelection" class="p-6 md:p-8 flex flex-col items-center justify-center min-h-[500px] fade-in">
            <h2 class="text-2xl font-bold mb-8 text-center">é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                <!-- æœ¬åœ°æ¸¸æˆ -->
                <div class="bg-gray-50 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow cursor-pointer" onclick="selectMode('local')">
                    <div class="flex items-center justify-center mb-4">
                        <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-laptop text-2xl text-primary"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold text-center mb-2">æœ¬åœ°æ¸¸æˆ</h3>
                    <p class="text-gray-600 text-center">åœ¨åŒä¸€å°è®¾å¤‡ä¸Šè¿›è¡ŒåŒäººå¯¹æˆ˜</p>
                </div>
                
                <!-- åœ¨çº¿å¯¹æˆ˜ -->
                <div class="bg-gray-50 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow cursor-pointer" onclick="selectMode('online')">
                    <div class="flex items-center justify-center mb-4">
                        <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-globe text-2xl text-primary"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold text-center mb-2">åœ¨çº¿å¯¹æˆ˜</h3>
                    <p class="text-gray-600 text-center">é€šè¿‡ç½‘ç»œä¸è¿œç¨‹ç©å®¶è¿›è¡Œå¯¹æˆ˜</p>
                </div>
            </div>
            
            <div class="mt-8 text-center text-sm text-gray-500">
                <p>Â© 2025 äº”å­æ£‹æ¸¸æˆ | æ”¯æŒæœ¬åœ°å’Œåœ¨çº¿å¯¹æˆ˜</p>
            </div>
        </div>
        
        <!-- åœ¨çº¿æ¸¸æˆç•Œé¢ -->
        <div id="onlineGameSetup" class="p-6 md:p-8 hidden fade-in">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- åˆ›å»ºæ¸¸æˆ -->
                <div class="flex-1 bg-gray-50 rounded-xl p-6 shadow-sm">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fa-solid fa-plus-circle mr-2 text-primary"></i>åˆ›å»ºæ¸¸æˆ
                    </h3>
                    <p class="text-gray-600 mb-4">åˆ›å»ºä¸€ä¸ªæ–°çš„æ¸¸æˆæˆ¿é—´ï¼Œç”Ÿæˆé“¾æ¥é‚€è¯·å¥½å‹åŠ å…¥</p>
                    <button id="createGameBtn" class="w-full bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                        <i class="fa-solid fa-gamepad mr-2"></i>åˆ›å»ºæ–°æ¸¸æˆ
                    </button>
                </div>
                
                <!-- åŠ å…¥æ¸¸æˆ -->
                <div class="flex-1 bg-gray-50 rounded-xl p-6 shadow-sm">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fa-solid fa-user-plus mr-2 text-primary"></i>åŠ å…¥æ¸¸æˆ
                    </h3>
                    <p class="text-gray-600 mb-4">è¾“å…¥æ¸¸æˆIDæˆ–ç²˜è´´æ¸¸æˆé“¾æ¥åŠ å…¥ç°æœ‰æ¸¸æˆ</p>
                    <div class="flex gap-3 mb-4">
                        <input type="text" id="gameIdInput" placeholder="è¾“å…¥æ¸¸æˆID" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <button id="joinGameBtn" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg font-medium btn-hover">
                            åŠ å…¥
                        </button>
                    </div>
                    <div class="flex gap-3">
                        <input type="text" id="gameLinkInput" placeholder="æˆ–ç²˜è´´æ¸¸æˆé“¾æ¥" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <button id="joinByLinkBtn" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg font-medium btn-hover">
                            åŠ å…¥
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ¸¸æˆé“¾æ¥åŒºåŸŸ -->
            <div id="gameLinkArea" class="mt-6 bg-green-50 rounded-xl p-6 shadow-sm hidden fade-in">
                <h3 class="text-xl font-semibold mb-4 flex items-center text-green-700">
                    <i class="fa-solid fa-link mr-2"></i>æ¸¸æˆé“¾æ¥å·²ç”Ÿæˆ
                </h3>
                <div class="flex gap-3 mb-4">
                    <input type="text" id="generatedGameLink" readonly="" class="flex-1 px-4 py-2 bg-white border border-green-300 rounded-lg">
                    <button id="copyLinkBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium btn-hover flex items-center">
                        <i class="fa-solid fa-copy mr-2"></i>å¤åˆ¶
                    </button>
                </div>
                <p class="text-green-700 flex items-center">
                    <i class="fa-solid fa-circle-info mr-2"></i>
                    <span>å°†æ­¤é“¾æ¥åˆ†äº«ç»™å¥½å‹ï¼Œç­‰å¾…ä»–ä»¬åŠ å…¥æ¸¸æˆ</span>
                </p>
                
                <!-- ç­‰å¾…æŒ‡ç¤ºå™¨ -->
                <div class="mt-6 flex flex-col items-center">
                    <div class="pulse-animation w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4">
                        <i class="fa-solid fa-user-clock text-2xl text-primary"></i>
                    </div>
                    <p id="waitingText" class="text-gray-600">ç­‰å¾…ç©å®¶åŠ å…¥...</p>
                    <div class="mt-4">
                        <button id="cancelGameBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-6 rounded-lg font-medium btn-hover">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button id="backToModeBtn" class="text-primary hover:text-primary/80 font-medium flex items-center mx-auto">
                    <i class="fa-solid fa-arrow-left mr-2"></i>è¿”å›æ¨¡å¼é€‰æ‹©
                </button>
            </div>
        </div>
        
        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <div id="gameInterface" class="p-6 md:p-8 flex flex-col md:flex-row gap-6 hidden fade-in">
            <!-- æ¸¸æˆåŒºåŸŸ -->
            <div class="flex-1 relative">
                <div class="aspect-square bg-board rounded-lg shadow-lg overflow-hidden board-grid" style="background-size: calc(100% / 14) calc(100% / 14);">
                    <canvas id="gameCanvas" class="w-full h-full cursor-pointer"></canvas>
                </div>
                
                <div id="gameStatus" class="mt-4 p-3 bg-secondary/20 rounded-lg text-center">
                    <p id="statusText" class="font-medium">æ¸¸æˆå¼€å§‹! é»‘æ£‹å…ˆè¡Œ</p>
                </div>
            </div>
            
            <!-- æ¸¸æˆæ§åˆ¶å’Œä¿¡æ¯ -->
            <div class="w-full md:w-96 flex flex-col gap-6">
                <!-- ç©å®¶ä¿¡æ¯ -->
                <div class="bg-gray-50 rounded-lg p-5 shadow-sm">
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fa-solid fa-users mr-2 text-primary"></i>ç©å®¶ä¿¡æ¯
                    </h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-6 h-6 rounded-full bg-black mr-2 piece-shadow"></div>
                                <span class="text-gray-700">é»‘æ£‹</span>
                            </div>
                            <div id="player1Status" class="flex items-center">
                                <span id="player1Name" class="text-sm">ä½ </span>
                                <span class="ml-2 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">åœ¨çº¿</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-6 h-6 rounded-full bg-white border border-gray-300 mr-2 piece-shadow"></div>
                                <span class="text-gray-700">ç™½æ£‹</span>
                            </div>
                            <div id="player2Status" class="flex items-center">
                                <span id="player2Name" class="text-sm">ç­‰å¾…ä¸­...</span>
                                <span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full">ç¦»çº¿</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¸æˆä¿¡æ¯ -->
                <div class="bg-gray-50 rounded-lg p-5 shadow-sm">
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fa-solid fa-info-circle mr-2 text-primary"></i>æ¸¸æˆä¿¡æ¯
                    </h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">å½“å‰å›åˆ</span>
                            <div class="flex items-center">
                                <div id="currentPlayer" class="w-6 h-6 rounded-full bg-black mr-2 piece-shadow"></div>
                                <span id="playerText">é»‘æ£‹</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">æ¸¸æˆæ—¶é—´</span>
                            <span id="gameTime" class="font-mono">00:00</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">æ­¥æ•°</span>
                            <span id="moveCount">0</span>
                        </div>
                        <div id="connectionStatus" class="flex items-center justify-between">
                            <span class="text-gray-600">è¿æ¥çŠ¶æ€</span>
                            <div class="flex items-center">
                                <span id="connectionIndicator" class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                                <span id="connectionText" class="text-sm text-green-600">å·²è¿æ¥</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¸æˆè§„åˆ™ -->
                <div class="bg-gray-50 rounded-lg p-5 shadow-sm">
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fa-solid fa-crown mr-2 text-primary"></i>æ¸¸æˆè§„åˆ™
                    </h2>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li class="flex items-start">
                            <i class="fa-solid fa-circle text-xs mt-1.5 mr-2 text-primary"></i>
                            <span>é»‘æ£‹å’Œç™½æ£‹è½®æµåœ¨æ£‹ç›˜ä¸Šè½å­</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-circle text-xs mt-1.5 mr-2 text-primary"></i>
                            <span>å…ˆåœ¨æ¨ªã€ç«–æˆ–æ–œæ–¹å‘å½¢æˆäº”å­è¿çº¿è€…è·èƒœ</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-circle text-xs mt-1.5 mr-2 text-primary"></i>
                            <span>ç‚¹å‡»æ£‹ç›˜ä¸Šçš„äº¤å‰ç‚¹æ”¾ç½®æ£‹å­</span>
                        </li>
                    </ul>
                </div>
                
                <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
                <div class="flex gap-3">
                    <button id="restartBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                        <i class="fa-solid fa-refresh mr-2"></i>é‡æ–°å¼€å§‹
                    </button>
                    <button id="undoBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                        <i class="fa-solid fa-undo mr-2"></i>æ‚”æ£‹
                    </button>
                </div>
                
                <!-- èŠå¤©åŒºåŸŸ -->
                <div class="bg-gray-50 rounded-lg p-5 shadow-sm">
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fa-solid fa-comments mr-2 text-primary"></i>èŠå¤©
                    </h2>
                    <div id="chatMessages" class="h-40 overflow-y-auto mb-3 p-3 bg-white rounded-lg border border-gray-200">
                        <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                <button id="emojiBtn" class="p-1 text-gray-500 hover:text-primary transition-colors">
                                    <i class="fa-solid fa-face-smile text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <button id="sendMessageBtn" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                            <i class="fa-solid fa-paper-plane mr-2"></i>å‘é€
                        </button>
                    </div>
                    <!-- å¢å¼ºçš„è¡¨æƒ…é€‰æ‹©å™¨ -->
                    <div id="emojiPicker" class="absolute bottom-full mb-2 left-0 right-0 bg-white rounded-lg shadow-xl p-4 hidden z-10">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-gray-700">é€‰æ‹©è¡¨æƒ…</h3>
                            <button id="closeEmojiBtn" class="text-gray-400 hover:text-gray-600">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-8 gap-2 mb-3">
                            <!-- ç¬‘è„¸è¡¨æƒ… -->
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="smile">ğŸ˜Š</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="smile">ğŸ˜‚</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="smile">ğŸ˜</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="smile">ğŸ˜</span>
                            <!-- æƒ…ç»ªè¡¨æƒ… -->
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="emotion">ğŸ¤”</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="emotion">ğŸ˜®</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="emotion">ğŸ˜¢</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="emotion">ğŸ˜¡</span>
                            <!-- æ‰‹åŠ¿è¡¨æƒ… -->
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="gesture">ğŸ‘</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="gesture">ğŸ‘</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="gesture">ğŸ‘</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="gesture">ğŸ™</span>
                            <!-- ç¬¦å·è¡¨æƒ… -->
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="symbol">ğŸ‰</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="symbol">ğŸ”¥</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="symbol">ğŸ’ª</span>
                            <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-transform hover:scale-110" data-category="symbol">â¤ï¸</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>ç‚¹å‡»è¡¨æƒ…æ·»åŠ åˆ°æ¶ˆæ¯ä¸­</span>
                            <span>æ”¯æŒæ–‡æœ¬+è¡¨æƒ…æ··åˆå‘é€</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button id="resignBtn" class="flex-1 bg-red-100 hover:bg-red-200 text-red-700 py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                        <i class="fa-solid fa-flag mr-2"></i>è®¤è¾“
                    </button>
                    <button id="exitBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                        <i class="fa-solid fa-sign-out-alt mr-2"></i>é€€å‡º
                    </button>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <div id="footer" class="bg-gray-50 p-4 text-center text-sm text-gray-500">
            <p>Â© 2025 äº”å­æ£‹æ¸¸æˆ | æ”¯æŒæœ¬åœ°å’Œåœ¨çº¿å¯¹æˆ˜</p>
        </div>
    </div>

    <!-- èƒœåˆ©æç¤ºæ¨¡æ€æ¡† -->
    <div id="winModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-trophy text-3xl text-yellow-500"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2" id="winnerText">é»‘æ£‹è·èƒœ!</h2>
                <p class="text-gray-600 mb-6">æ­å–œæ‚¨èµ¢å¾—äº†è¿™åœºç²¾å½©çš„æ¯”èµ›!</p>
                <div class="flex gap-3">
                    <button id="newGameBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover">
                        å¼€å§‹æ–°æ¸¸æˆ
                    </button>
                    <button id="backToMenuBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium btn-hover">
                        è¿”å›èœå•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–­çº¿æç¤ºæ¨¡æ€æ¡† -->
    <div id="disconnectModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-wifi-slash text-3xl text-yellow-500"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">è¿æ¥æ–­å¼€</h2>
                <p class="text-gray-600 mb-6">ä¸å¯¹æ‰‹çš„è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...</p>
                <div class="flex gap-3">
                    <button id="reconnectBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover">
                        é‡æ–°è¿æ¥
                    </button>
                    <button id="abandonGameBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium btn-hover">
                        æ”¾å¼ƒæ¸¸æˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentMode = null; // 'local' æˆ– 'online'
        let socket = null; // Socket.ioå®ä¾‹
        let roomId = null; // æ¸¸æˆæˆ¿é—´ID
        let isHost = false; // æ˜¯å¦æ˜¯æˆ¿ä¸»
        let connectionTimer = null; // è¿æ¥è®¡æ—¶å™¨
        let reconnectAttempts = 0; // é‡è¿å°è¯•æ¬¡æ•°
        const MAX_RECONNECT_ATTEMPTS = 5; // æœ€å¤§é‡è¿æ¬¡æ•°
        let selectedEmoji = 'ğŸ˜Š'; // é»˜è®¤é€‰ä¸­çš„è¡¨æƒ…
        
        // æ¸¸æˆå¸¸é‡
        const BOARD_SIZE = 15; // 15x15çš„æ£‹ç›˜
        let CELL_SIZE; // å•å…ƒæ ¼å¤§å°
        let PIECE_SIZE; // æ£‹å­å¤§å°
        
        // æ¸¸æˆçŠ¶æ€
        let gameBoard = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
        let currentPlayer = 1; // 1: é»‘æ£‹, 2: ç™½æ£‹
        let gameActive = true;
        let moveHistory = [];
        let gameTime = 0;
        let timerInterval;
        let winner = 0; // 0:æ— , 1:é»‘, 2:ç™½
        let playerColor = 1; // å½“å‰ç©å®¶çš„æ£‹å­é¢œè‰²
        let opponentColor = 2; // å¯¹æ‰‹çš„æ£‹å­é¢œè‰²
        
        // DOMå…ƒç´ 
        const modeSelection = document.getElementById('modeSelection');
        const onlineGameSetup = document.getElementById('onlineGameSetup');
        const gameInterface = document.getElementById('gameInterface');
        const gameLinkArea = document.getElementById('gameLinkArea');
        const generatedGameLink = document.getElementById('generatedGameLink');
        const waitingText = document.getElementById('waitingText');
        const player1Name = document.getElementById('player1Name');
        const player2Name = document.getElementById('player2Name');
        const player1Status = document.getElementById('player1Status');
        const player2Status = document.getElementById('player2Status');
        const connectionIndicator = document.getElementById('connectionIndicator');
        const connectionText = document.getElementById('connectionText');
        
        // æ¸¸æˆç”»å¸ƒå…ƒç´ 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ¸¸æˆçŠ¶æ€å…ƒç´ 
        const statusText = document.getElementById('statusText');
        const currentPlayerEl = document.getElementById('currentPlayer');
        const playerText = document.getElementById('playerText');
        const moveCountEl = document.getElementById('moveCount');
        const gameTimeEl = document.getElementById('gameTime');
        
        // æŒ‰é’®å…ƒç´ 
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const joinByLinkBtn = document.getElementById('joinByLinkBtn');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const cancelGameBtn = document.getElementById('cancelGameBtn');
        const backToModeBtn = document.getElementById('backToModeBtn');
        const restartBtn = document.getElementById('restartBtn');
        const undoBtn = document.getElementById('undoBtn');
        const resignBtn = document.getElementById('resignBtn');
        const exitBtn = document.getElementById('exitBtn');
        const newGameBtn = document.getElementById('newGameBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const reconnectBtn = document.getElementById('reconnectBtn');
        const abandonGameBtn = document.getElementById('abandonGameBtn');
        
        // æ¨¡æ€æ¡†å…ƒç´ 
        const winModal = document.getElementById('winModal');
        const winnerText = document.getElementById('winnerText');
        const disconnectModal = document.getElementById('disconnectModal');
        
        // èŠå¤©ç›¸å…³å…ƒç´ 
        const chatMessages = document.getElementById('chatMessages');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const messageInput = document.getElementById('messageInput');
        const closeEmojiBtn = document.getElementById('closeEmojiBtn');
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            // æ¨¡å¼é€‰æ‹©æŒ‰é’®
            createGameBtn.addEventListener('click', createGame);
            joinGameBtn.addEventListener('click', joinGame);
            joinByLinkBtn.addEventListener('click', joinGameByLink);
            copyLinkBtn.addEventListener('click', copyGameLink);
            cancelGameBtn.addEventListener('click', cancelGame);
            backToModeBtn.addEventListener('click', backToModeSelection);
            
            // æ¸¸æˆæ§åˆ¶æŒ‰é’®
            restartBtn.addEventListener('click', restartGame);
            undoBtn.addEventListener('click', undoMove);
            resignBtn.addEventListener('click', resignGame);
            exitBtn.addEventListener('click', exitGame);
            newGameBtn.addEventListener('click', startNewGame);
            backToMenuBtn.addEventListener('click', backToMainMenu);
            reconnectBtn.addEventListener('click', reconnectToGame);
            abandonGameBtn.addEventListener('click', abandonGame);
            
            // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜æ£‹ç›˜
            window.addEventListener('resize', () => {
                if (currentMode) {
                    initGameCanvas();
                    drawBoard();
                }
            });
            
            // ä»URLå‚æ•°ä¸­æ£€æŸ¥æ˜¯å¦æœ‰æ¸¸æˆID
            const urlParams = new URLSearchParams(window.location.search);
            const gameIdParam = urlParams.get('gameId');
            if (gameIdParam) {
                document.getElementById('gameIdInput').value = gameIdParam;
                // ä¸è‡ªåŠ¨åŠ å…¥ï¼Œè®©ç”¨æˆ·ç‚¹å‡»åŠ å…¥æŒ‰é’®
            }
            
            // èŠå¤©ç›¸å…³äº‹ä»¶ç›‘å¬
            emojiBtn.addEventListener('click', toggleEmojiPicker);
            sendMessageBtn.addEventListener('click', sendMessage);
            closeEmojiBtn.addEventListener('click', () => emojiPicker.classList.add('hidden'));
            
            // å›è½¦é”®å‘é€æ¶ˆæ¯
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // è¡¨æƒ…é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.emoji-item').forEach(item => {
                item.addEventListener('click', () => {
                    const emoji = item.textContent;
                    // å°†è¡¨æƒ…æ’å…¥åˆ°è¾“å…¥æ¡†ä¸­
                    const cursorPos = messageInput.selectionStart;
                    const textBefore = messageInput.value.substring(0, cursorPos);
                    const textAfter = messageInput.value.substring(cursorPos);
                    messageInput.value = textBefore + emoji + textAfter;
                    
                    // å°†å…‰æ ‡å®šä½åˆ°è¡¨æƒ…åé¢
                    messageInput.focus();
                    messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—è¡¨æƒ…é€‰æ‹©å™¨
            document.addEventListener('click', (e) => {
                if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                    emojiPicker.classList.add('hidden');
                }
            });
        });
        
        // é€‰æ‹©æ¸¸æˆæ¨¡å¼
        function selectMode(mode) {
            currentMode = mode;
            
            if (mode === 'local') {
                // æœ¬åœ°æ¸¸æˆæ¨¡å¼
                modeSelection.classList.add('hidden');
                gameInterface.classList.remove('hidden');
                initGame();
            } else if (mode === 'online') {
                // åœ¨çº¿æ¸¸æˆæ¨¡å¼
                modeSelection.classList.add('hidden');
                onlineGameSetup.classList.remove('hidden');
            }
        }
        
        // è¿”å›æ¨¡å¼é€‰æ‹©
        function backToModeSelection() {
            currentMode = null;
            onlineGameSetup.classList.add('hidden');
            modeSelection.classList.remove('hidden');
            gameLinkArea.classList.add('hidden');
        }
        
        // åˆå§‹åŒ–Socket.ioè¿æ¥
        function initSocket() {
            socket = io();
            
            // ç›‘å¬è¿æ¥äº‹ä»¶
            socket.on('connect', () => {
                console.log('Socket.ioè¿æ¥å·²å»ºç«‹');
                updateConnectionStatus(true);
            });
            
            // ç›‘å¬æ–­å¼€è¿æ¥
            socket.on('disconnect', () => {
                console.log('Socket.ioè¿æ¥å·²æ–­å¼€');
                updateConnectionStatus(false);
                if (gameActive) {
                    showDisconnectModal();
                }
            });
            
            // ç›‘å¬æˆ¿é—´æ›´æ–°
            socket.on('room-updated', (room) => {
                console.log('æˆ¿é—´æ›´æ–°:', room);
                if (room.players.length === 2 && !gameActive) {
                    // æˆ¿é—´å·²æ»¡ï¼Œå¼€å§‹æ¸¸æˆ
                    onlineGameSetup.classList.add('hidden');
                    gameInterface.classList.remove('hidden');
                    gameLinkArea.classList.add('hidden');
                    initGame();
                }
            });
            
            // ç›‘å¬æ¸¸æˆå¼€å§‹
            socket.on('game-start', (room) => {
                console.log('æ¸¸æˆå¼€å§‹:', room);
                gameActive = room.gameActive;
                currentPlayer = room.currentPlayer;
                gameBoard = room.gameBoard;
                updateGameStatus();
            });
            
            // ç›‘å¬è½å­
            socket.on('move-made', (data) => {
                console.log('æ”¶åˆ°è½å­:', data);
                const { row, col, player, room } = data;
                gameBoard[row][col] = player;
                moveHistory.push({ row, col, player });
                drawBoard();
                
                // æ£€æŸ¥æ˜¯å¦èƒœåˆ©
                if (room.winner !== 0) {
                    winner = room.winner;
                    showWinModal(winner);
                    return;
                }
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                currentPlayer = room.currentPlayer;
                gameActive = room.gameActive;
                updateGameStatus();
            });
            
            // ç›‘å¬æ¸¸æˆé‡æ–°å¼€å§‹
            socket.on('game-restarted', (room) => {
                console.log('æ¸¸æˆé‡æ–°å¼€å§‹:', room);
                gameBoard = room.gameBoard;
                currentPlayer = room.currentPlayer;
                gameActive = room.gameActive;
                moveHistory = [];
                gameTime = 0;
                winner = 0;
                drawBoard();
                updateGameStatus();
            });
            
            // ç›‘å¬æ‚”æ£‹
            socket.on('move-undo', (data) => {
                console.log('æ”¶åˆ°æ‚”æ£‹:', data);
                const { room } = data;
                gameBoard = room.gameBoard;
                currentPlayer = room.currentPlayer;
                moveHistory = room.moveHistory;
                drawBoard();
                updateGameStatus();
            });
            
            // ç›‘å¬æ¸¸æˆç»“æŸ
            socket.on('game-over', (data) => {
                console.log('æ¸¸æˆç»“æŸ:', data);
                const { winner, room } = data;
                this.winner = winner;
                gameActive = room.gameActive;
                showWinModal(winner);
            });
            
            // ç›‘å¬èŠå¤©æ¶ˆæ¯
            socket.on('chat-message', (data) => {
                console.log('æ”¶åˆ°èŠå¤©æ¶ˆæ¯:', data);
                handleChatMessage(data);
            });
            
            // ç›‘å¬é”™è¯¯
            socket.on('error', (error) => {
                console.error('Socket.ioé”™è¯¯:', error);
                showError(error.message || 'è¿æ¥é”™è¯¯');
            });
        }
        
        // åˆ›å»ºæ–°æ¸¸æˆ
        function createGame() {
            // å‘é€åˆ›å»ºæ¸¸æˆè¯·æ±‚
            fetch('/api/create-room')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        roomId = data.roomId;
                        isHost = true;
                        
                        // åˆå§‹åŒ–Socketè¿æ¥
                        if (!socket) {
                            initSocket();
                        }
                        
                        // åŠ å…¥æˆ¿é—´
                        socket.emit('join-room', {
                            roomId: data.roomId,
                            playerName: 'ç©å®¶1'
                        });
                        
                        // ç”Ÿæˆæ¸¸æˆé“¾æ¥
                        const gameLink = `${window.location.origin}${window.location.pathname}?roomId=${data.roomId}`;
                        generatedGameLink.value = gameLink;
                        
                        // æ˜¾ç¤ºæ¸¸æˆé“¾æ¥åŒºåŸŸ
                        gameLinkArea.classList.remove('hidden');
                        waitingText.textContent = 'ç­‰å¾…ç©å®¶åŠ å…¥...';
                    } else {
                        showError('æ— æ³•åˆ›å»ºæ¸¸æˆï¼Œè¯·é‡è¯•');
                    }
                })
                .catch(error => {
                    console.error('åˆ›å»ºæ¸¸æˆé”™è¯¯:', error);
                    showError('æ— æ³•åˆ›å»ºæ¸¸æˆï¼Œè¯·é‡è¯•');
                });
        }
        
        // åŠ å…¥æ¸¸æˆ
        function joinGame() {
            const roomIdInput = document.getElementById('gameIdInput').value.trim();
            if (!roomIdInput) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„æˆ¿é—´ID');
                return;
            }
            
            roomId = roomIdInput;
            
            // åˆå§‹åŒ–Socketè¿æ¥
            if (!socket) {
                initSocket();
            }
            
            // åŠ å…¥æˆ¿é—´
            socket.emit('join-room', {
                roomId: roomIdInput,
                playerName: 'ç©å®¶2'
            });
            
            // æ˜¾ç¤ºè¿æ¥ä¸­çŠ¶æ€
            waitingText.textContent = 'æ­£åœ¨åŠ å…¥æ¸¸æˆ...';
            gameLinkArea.classList.remove('hidden');
        }
        
        // é€šè¿‡é“¾æ¥åŠ å…¥æ¸¸æˆ
        function joinGameByLink() {
            const linkInput = document.getElementById('gameLinkInput').value.trim();
            if (!linkInput) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¸¸æˆé“¾æ¥');
                return;
            }
            
            try {
                const url = new URL(linkInput);
                const roomIdParam = url.searchParams.get('roomId');
                
                if (!roomIdParam) {
                    showError('æ— æ•ˆçš„æ¸¸æˆé“¾æ¥');
                    return;
                }
                
                // å¡«å……æˆ¿é—´IDå¹¶è°ƒç”¨åŠ å…¥æ¸¸æˆ
                document.getElementById('gameIdInput').value = roomIdParam;
                joinGame();
            } catch (e) {
                showError('æ— æ•ˆçš„é“¾æ¥æ ¼å¼');
            }
        }
        
        // å¤„ç†èŠå¤©æ¶ˆæ¯
        function handleChatMessage(data) {
            const { sender, text, timestamp } = data;
            const isMe = sender === (isHost ? 'host' : 'guest');
            const senderName = isMe ? 'æˆ‘' : 'å¯¹æ‰‹';
            const senderClass = isMe ? 'bg-primary/10 text-primary' : 'bg-gray-100 text-gray-700';
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageElement = document.createElement('div');
            messageElement.className = `flex items-center mb-2 slide-in`;
            messageElement.innerHTML = `
                <div class="flex items-center ${isMe ? 'justify-end' : 'justify-start'} w-full">
                    <div class="flex items-center gap-2 ${isMe ? 'flex-row-reverse' : ''}">
                        <div class="w-6 h-6 rounded-full ${isHost ? 'bg-black' : 'bg-white border border-gray-300'} piece-shadow"></div>
                        <div class="px-3 py-2 rounded-lg ${senderClass} max-w-[80%]">
                            <span>${text}</span>
                        </div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 ${isMe ? 'text-right' : 'text-left'} w-full mb-1">
                    ${senderName} Â· ${formatTime(timestamp)}
                </div>
            `;
            
            // æ·»åŠ åˆ°èŠå¤©åŒºåŸŸ
            chatMessages.appendChild(messageElement);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨æ˜¾ç¤º/éšè—
        function toggleEmojiPicker() {
            emojiPicker.classList.toggle('hidden');
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;
            
            // åˆ›å»ºæ¶ˆæ¯æ•°æ®
            const messageData = {
                sender: isHost ? 'host' : 'guest',
                text: messageText,
                timestamp: Date.now()
            };
            
            // åœ¨æœ¬åœ°æ˜¾ç¤ºæ¶ˆæ¯
            handleChatMessage(messageData);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
            
            // éšè—è¡¨æƒ…é€‰æ‹©å™¨
            emojiPicker.classList.add('hidden');
            
            // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œå‘é€ç»™å¯¹æ‰‹
            if (currentMode === 'online' && socket) {
                socket.emit('send-chat', {
                    roomId: roomId,
                    sender: messageData.sender,
                    text: messageData.text,
                    timestamp: messageData.timestamp
                });
            }
        }
        
        // å¤åˆ¶æ¸¸æˆé“¾æ¥
        function copyGameLink() {
            generatedGameLink.select();
            document.execCommand('copy');
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            copyLinkBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>å·²å¤åˆ¶';
            setTimeout(() => {
                copyLinkBtn.innerHTML = '<i class="fa-solid fa-copy mr-2"></i>å¤åˆ¶';
            }, 2000);
        }
        
        // å–æ¶ˆæ¸¸æˆ
        function cancelGame() {
            // å…³é—­Peerè¿æ¥
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            // é‡ç½®å˜é‡
            gameId = null;
            connection = null;
            isHost = false;
            
            // éšè—æ¸¸æˆé“¾æ¥åŒºåŸŸ
            gameLinkArea.classList.add('hidden');
        }
        
        // é€€å‡ºæ¸¸æˆ
        function exitGame() {
            // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œé€šçŸ¥å¯¹æ‰‹
            if (currentMode === 'online' && socket) {
                socket.emit('leave-room', roomId);
            }
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            resetGameState();
            
            // è¿”å›ä¸»èœå•
            backToMainMenu();
        }
        
        // æ”¾å¼ƒæ¸¸æˆ
        function abandonGame() {
            // å…³é—­æ–­çº¿æ¨¡æ€æ¡†
            hideDisconnectModal();
            
            // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œé€šçŸ¥å¯¹æ‰‹
            if (currentMode === 'online' && socket) {
                socket.emit('leave-room', roomId);
            }
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            resetGameState();
            
            // è¿”å›ä¸»èœå•
            backToMainMenu();
        }
        
        // é‡æ–°è¿æ¥æ¸¸æˆ
        function reconnectToGame() {
            // å¢åŠ é‡è¿å°è¯•æ¬¡æ•°
            reconnectAttempts++;
            
            // å¦‚æœè¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒé‡è¿
            if (reconnectAttempts > MAX_RECONNECT_ATTEMPTS) {
                showError('æ— æ³•é‡æ–°è¿æ¥ï¼Œè¯·æ”¾å¼ƒæ¸¸æˆ');
                return;
            }
            
            // éšè—æ–­çº¿æ¨¡æ€æ¡†
            hideDisconnectModal();
            
            // æ˜¾ç¤ºé‡è¿ä¸­çŠ¶æ€
            updateConnectionStatus(false, 'é‡è¿ä¸­...');
            
            // å°è¯•é‡æ–°è¿æ¥
            if (currentMode === 'online' && roomId) {
                // é‡æ–°åˆå§‹åŒ–Socketè¿æ¥
                if (socket) {
                    socket.disconnect();
                }
                
                // é‡æ–°åŠ å…¥æˆ¿é—´
                initSocket();
                socket.on('connect', () => {
                    socket.emit('join-room', {
                        roomId: roomId,
                        playerName: isHost ? 'ç©å®¶1' : 'ç©å®¶2'
                    });
                });
            }
            
            // è®¾ç½®é‡è¿è¶…æ—¶
            connectionTimer = setTimeout(() => {
                if (!socket || !socket.connected) {
                    showDisconnectModal();
                }
            }, 10000);
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
            resetGameState();
            
            // åˆå§‹åŒ–æ¸¸æˆç”»å¸ƒ
            initGameCanvas();
            
            // ç»˜åˆ¶æ£‹ç›˜
            drawBoard();
            
            // å¼€å§‹è®¡æ—¶
            startTimer();
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
            updateGameStatus();
            
            // å¦‚æœæ˜¯æœ¬åœ°æ¸¸æˆï¼Œè®¾ç½®ç©å®¶åç§°
            if (currentMode === 'local') {
                player1Name.textContent = 'ç©å®¶1';
                player2Name.textContent = 'ç©å®¶2';
                player2Status.innerHTML = '<span class="ml-2 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">åœ¨çº¿</span>';
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆç”»å¸ƒ
        function initGameCanvas() {
            // è®¡ç®—å•å…ƒæ ¼å¤§å°
            CELL_SIZE = Math.min(
                (canvas.parentElement.clientWidth - 20) / (BOARD_SIZE - 1),
                (canvas.parentElement.clientHeight - 20) / (BOARD_SIZE - 1)
            );
            
            // è®¡ç®—æ£‹å­å¤§å°
            PIECE_SIZE = CELL_SIZE * 0.8;
            
            // è®¾ç½®Canvaså°ºå¯¸
            canvas.width = CELL_SIZE * (BOARD_SIZE - 1);
            canvas.height = CELL_SIZE * (BOARD_SIZE - 1);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            canvas.addEventListener('click', handleCanvasClick);
            
            // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            
            // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶
            canvas.addEventListener('mouseleave', () => {
                if (gameActive) {
                    drawBoard();
                }
            });
        }
        
        // ç»˜åˆ¶æ£‹ç›˜
        function drawBoard() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 1.5;
            
            for (let i = 0; i < BOARD_SIZE; i++) {
                // æ°´å¹³çº¿
                ctx.beginPath();
                ctx.moveTo(0, i * CELL_SIZE);
                ctx.lineTo(canvas.width, i * CELL_SIZE);
                ctx.stroke();
                
                // å‚ç›´çº¿
                ctx.beginPath();
                ctx.moveTo(i * CELL_SIZE, 0);
                ctx.lineTo(i * CELL_SIZE, canvas.height);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶å¤©å…ƒå’Œæ˜Ÿä½
            const starPoints = [
                {x: 3, y: 3}, {x: 3, y: 11}, {x: 7, y: 7}, 
                {x: 11, y: 3}, {x: 11, y: 11}
            ];
            
            starPoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x * CELL_SIZE, point.y * CELL_SIZE, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#8B4513';
                ctx.fill();
            });
            
            // ç»˜åˆ¶æ£‹å­
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    if (gameBoard[i][j] !== 0) {
                        drawPiece(i, j, gameBoard[i][j]);
                    }
                }
            }
        }
        
        // ç»˜åˆ¶æ£‹å­
        function drawPiece(row, col, player) {
            const x = col * CELL_SIZE;
            const y = row * CELL_SIZE;
            
            // æ£‹å­é˜´å½±
            ctx.beginPath();
            ctx.arc(x, y, PIECE_SIZE / 2 + 2, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fill();
            
            // æ£‹å­æœ¬ä½“
            ctx.beginPath();
            ctx.arc(x, y, PIECE_SIZE / 2, 0, Math.PI * 2);
            
            if (player === 1) {
                // é»‘æ£‹ - æ¸å˜æ•ˆæœ
                const gradient = ctx.createRadialGradient(
                    x - PIECE_SIZE / 6, y - PIECE_SIZE / 6, PIECE_SIZE / 10,
                    x, y, PIECE_SIZE / 2
                );
                gradient.addColorStop(0, '#555');
                gradient.addColorStop(1, '#000');
                ctx.fillStyle = gradient;
            } else {
                // ç™½æ£‹ - æ¸å˜æ•ˆæœ
                const gradient = ctx.createRadialGradient(
                    x - PIECE_SIZE / 6, y - PIECE_SIZE / 6, PIECE_SIZE / 10,
                    x, y, PIECE_SIZE / 2
                );
                gradient.addColorStop(0, '#fff');
                gradient.addColorStop(1, '#ddd');
                ctx.fillStyle = gradient;
            }
            
            ctx.fill();
            
            // æ£‹å­è¾¹ç¼˜
            ctx.strokeStyle = player === 1 ? '#333' : '#ccc';
            ctx.lineWidth = 1;
            ctx.stroke();
        }
        
        // å¤„ç†ç”»å¸ƒç‚¹å‡»äº‹ä»¶
        function handleCanvasClick(e) {
            if (!gameActive) return;
            
            // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œæ£€æŸ¥æ˜¯å¦è½®åˆ°å½“å‰ç©å®¶
            if (currentMode === 'online') {
                // ç¡®å®šå½“å‰ç©å®¶çš„æ£‹å­é¢œè‰²
                const myPlayer = isHost ? 1 : 2; // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ ¹æ®æ¸¸æˆå¼€å§‹æ—¶çš„åˆ†é…
                
                // å¦‚æœä¸æ˜¯å½“å‰ç©å®¶çš„å›åˆï¼Œä¸å¤„ç†ç‚¹å‡»
                if (currentPlayer !== myPlayer) {
                    return;
                }
            }
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            // è®¡ç®—ç‚¹å‡»çš„æ ¼å­åæ ‡
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            const col = Math.round(x / CELL_SIZE);
            const row = Math.round(y / CELL_SIZE);
            
            // æ£€æŸ¥åæ ‡æ˜¯å¦åœ¨æ£‹ç›˜å†…ä¸”ä¸ºç©º
            if (isValidMove(row, col)) {
                // è½å­
                gameBoard[row][col] = currentPlayer;
                moveHistory.push({ row, col, player: currentPlayer });
                
                // é‡ç»˜æ£‹ç›˜
                drawBoard();
                
                // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œå‘é€è½å­ä¿¡æ¯ç»™å¯¹æ‰‹
                if (currentMode === 'online' && socket) {
                    socket.emit('make-move', {
                        roomId: roomId,
                        row,
                        col
                    });
                }
                
                // æ£€æŸ¥æ˜¯å¦èƒœåˆ©
                if (checkWin(row, col, currentPlayer)) {
                    winner = currentPlayer;
                    
                    // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œå‘é€èƒœåˆ©ä¿¡æ¯ç»™å¯¹æ‰‹
                    if (currentMode === 'online' && socket) {
                        socket.emit('game-control', {
                            roomId: roomId,
                            action: 'game-over',
                            data: { winner: currentPlayer }
                        });
                    }
                    
                    showWinModal(winner);
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å¹³å±€
                if (checkDraw()) {
                    gameActive = false;
                    statusText.textContent = 'æ¸¸æˆç»“æŸ - å¹³å±€!';
                    
                    // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œå‘é€å¹³å±€ä¿¡æ¯ç»™å¯¹æ‰‹
                    if (currentMode === 'online' && socket) {
                        socket.emit('game-control', {
                            roomId: roomId,
                            action: 'game-over',
                            data: { winner: 0 } // 0è¡¨ç¤ºå¹³å±€
                        });
                    }
                    return;
                }
                
                // åˆ‡æ¢ç©å®¶
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
                updateGameStatus();
            }
        }
        
        // å¤„ç†ç”»å¸ƒé¼ æ ‡æ‚¬åœäº‹ä»¶
        function handleCanvasMouseMove(e) {
            if (!gameActive) return;
            
            // ç»˜åˆ¶å½“å‰æ£‹ç›˜
            drawBoard();
            
            // è®¡ç®—é¼ æ ‡ä½ç½®
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            const col = Math.round(x / CELL_SIZE);
            const row = Math.round(y / CELL_SIZE);
            
            // å¦‚æœä½ç½®æœ‰æ•ˆä¸”ä¸ºç©ºï¼Œæ˜¾ç¤ºé¢„è§ˆæ£‹å­
            if (isValidMove(row, col)) {
                ctx.beginPath();
                ctx.arc(col * CELL_SIZE, row * CELL_SIZE, PIECE_SIZE / 2, 0, Math.PI * 2);
                ctx.fillStyle = currentPlayer === 1 ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.7)';
                ctx.fill();
            }
        }
        
        // æ£€æŸ¥è½å­æ˜¯å¦æœ‰æ•ˆ
        function isValidMove(row, col) {
            return row >= 0 && row < BOARD_SIZE && col >= 0 && col < BOARD_SIZE && gameBoard[row][col] === 0;
        }
        
        // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
        function checkWin(row, col, player) {
            // æ£€æŸ¥æ°´å¹³æ–¹å‘
            let count = 1;
            for (let i = col - 1; i >= 0 && gameBoard[row][i] === player; i--) count++;
            for (let i = col + 1; i < BOARD_SIZE && gameBoard[row][i] === player; i++) count++;
            if (count >= 5) return true;
            
            // æ£€æŸ¥å‚ç›´æ–¹å‘
            count = 1;
            for (let i = row - 1; i >= 0 && gameBoard[i][col] === player; i--) count++;
            for (let i = row + 1; i < BOARD_SIZE && gameBoard[i][col] === player; i++) count++;
            if (count >= 5) return true;
            
            // æ£€æŸ¥å¯¹è§’çº¿æ–¹å‘ï¼ˆå·¦ä¸Šåˆ°å³ä¸‹ï¼‰
            count = 1;
            for (let i = row - 1, j = col - 1; i >= 0 && j >= 0 && gameBoard[i][j] === player; i--, j--) count++;
            for (let i = row + 1, j = col + 1; i < BOARD_SIZE && j < BOARD_SIZE && gameBoard[i][j] === player; i++, j++) count++;
            if (count >= 5) return true;
            
            // æ£€æŸ¥å¯¹è§’çº¿æ–¹å‘ï¼ˆå³ä¸Šåˆ°å·¦ä¸‹ï¼‰
            count = 1;
            for (let i = row - 1, j = col + 1; i >= 0 && j < BOARD_SIZE && gameBoard[i][j] === player; i--, j++) count++;
            for (let i = row + 1, j = col - 1; i < BOARD_SIZE && j >= 0 && gameBoard[i][j] === player; i++, j--) count++;
            if (count >= 5) return true;
            
            return false;
        }
        
        // æ£€æŸ¥å¹³å±€
        function checkDraw() {
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    if (gameBoard[i][j] === 0) {
                        return false;
                    }
                }
            }
            return true;
        }
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            resetGame();
            
            // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œé€šçŸ¥å¯¹æ‰‹
            if (currentMode === 'online' && socket) {
                socket.emit('game-control', {
                    roomId: roomId,
                    action: 'restart',
                    data: {}
                });
            }
        }
        
        // æ‚”æ£‹
        function undoMove() {
            if (moveHistory.length === 0 || !gameActive) {
                return;
            }
            
            const lastMove = moveHistory.pop();
            gameBoard[lastMove.row][lastMove.col] = 0;
            currentPlayer = lastMove.player; // å›åˆ°ä¸Šä¸€ä¸ªç©å®¶
            
            drawBoard();
            updateGameStatus();
            
            // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œé€šçŸ¥å¯¹æ‰‹
            if (currentMode === 'online' && socket) {
                socket.emit('game-control', {
                    roomId: roomId,
                    action: 'undo',
                    data: {}
                });
            }
        }
        
        // è®¤è¾“
        function resignGame() {
            if (!gameActive) return;
            
            winner = currentPlayer === 1 ? 2 : 1;
            
            // å¦‚æœæ˜¯åœ¨çº¿æ¸¸æˆï¼Œé€šçŸ¥å¯¹æ‰‹
            if (currentMode === 'online' && socket) {
                socket.emit('game-control', {
                    roomId: roomId,
                    action: 'resign',
                    data: { player: currentPlayer }
                });
            }
            
            showWinModal(winner);
        }
        
        // å¼€å§‹æ–°æ¸¸æˆ
        function startNewGame() {
            hideWinModal();
            resetGame();
        }
        
        // è¿”å›ä¸»èœå•
        function backToMainMenu() {
            hideWinModal();
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            resetGameState();
            
            // æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©ç•Œé¢
            modeSelection.classList.remove('hidden');
            gameInterface.classList.add('hidden');
            onlineGameSetup.classList.add('hidden');
        }
        
        // é‡ç½®æ¸¸æˆçŠ¶æ€
        function resetGameState() {
            // åœæ­¢è®¡æ—¶
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameBoard = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
            currentPlayer = 1;
            gameActive = true;
            moveHistory = [];
            gameTime = 0;
            winner = 0;
            
            // é‡ç½®UI
            statusText.textContent = 'æ¸¸æˆå¼€å§‹! é»‘æ£‹å…ˆè¡Œ';
            gameTimeEl.textContent = '00:00';
            moveCountEl.textContent = '0';
            
            // é‡ç½®ç©å®¶çŠ¶æ€
            if (currentMode === 'online') {
                player2Name.textContent = 'ç­‰å¾…ä¸­...';
                player2Status.innerHTML = '<span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full">ç¦»çº¿</span>';
            }
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameBoard = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
            currentPlayer = 1;
            gameActive = true;
            moveHistory = [];
            gameTime = 0;
            winner = 0;
            
            // é‡ç½®UI
            statusText.textContent = 'æ¸¸æˆå¼€å§‹! é»‘æ£‹å…ˆè¡Œ';
            gameTimeEl.textContent = '00:00';
            moveCountEl.textContent = '0';
            
            // é‡æ–°ç»˜åˆ¶æ£‹ç›˜
            drawBoard();
            
            // é‡æ–°å¼€å§‹è®¡æ—¶
            startTimer();
        }
        
        // å¼€å§‹è®¡æ—¶
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                gameTime++;
                const minutes = Math.floor(gameTime / 60).toString().padStart(2, '0');
                const seconds = (gameTime % 60).toString().padStart(2, '0');
                gameTimeEl.textContent = `${minutes}:${seconds}`;
            }, 1000);
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
        function updateGameStatus() {
            statusText.textContent = gameActive ? 
                `æ¸¸æˆè¿›è¡Œä¸­ - ${currentPlayer === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹'}å›åˆ` : 
                `æ¸¸æˆç»“æŸ - ${winner === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹'}è·èƒœ!`;
            
            currentPlayerEl.className = `w-6 h-6 rounded-full ${currentPlayer === 1 ? 'bg-black' : 'bg-white border border-gray-300'} mr-2 piece-shadow`;
            playerText.textContent = currentPlayer === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹';
            moveCountEl.textContent = moveHistory.length;
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected, message) {
            if (connected) {
                connectionIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                connectionText.textContent = 'å·²è¿æ¥';
                connectionText.className = 'text-sm text-green-600';
            } else {
                connectionIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                connectionText.textContent = message || 'æœªè¿æ¥';
                connectionText.className = 'text-sm text-red-600';
            }
        }
        
        // æ˜¾ç¤ºèƒœåˆ©æ¨¡æ€æ¡†
        function showWinModal(winner) {
            winnerText.textContent = `${winner === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹'}è·èƒœ!`;
            winModal.classList.remove('hidden');
            setTimeout(() => {
                winModal.style.opacity = '1';
                winModal.querySelector('div').style.transform = 'scale(1)';
            }, 10);
        }
        
        // éšè—èƒœåˆ©æ¨¡æ€æ¡†
        function hideWinModal() {
            winModal.style.opacity = '0';
            winModal.querySelector('div').style.transform = 'scale(0.95)';
            setTimeout(() => {
                winModal.classList.add('hidden');
            }, 300);
        }
        
        // æ˜¾ç¤ºæ–­çº¿æ¨¡æ€æ¡†
        function showDisconnectModal() {
            disconnectModal.classList.remove('hidden');
            setTimeout(() => {
                disconnectModal.style.opacity = '1';
                disconnectModal.querySelector('div').style.transform = 'scale(1)';
            }, 10);
        }
        
        // éšè—æ–­çº¿æ¨¡æ€æ¡†
        function hideDisconnectModal() {
            disconnectModal.style.opacity = '0';
            disconnectModal.querySelector('div').style.transform = 'scale(0.95)';
            setTimeout(() => {
                disconnectModal.classList.add('hidden');
            }, 300);
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            alert(message);
        }
    </script>
</body>
</html>